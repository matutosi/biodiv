<html>
<head>
<!--  <script src="js/prototype.js"></script>    -->
<!--  <script src="js/fabtabulous.js"></script>  -->
<!--  <script src="js/tablekit.js"></script>     -->
<!--  <script src="sort.js"></script>            -->
<script src="table.js"></script>
<script src="date.js"></script>
<script src="download.js"></script>
<script src="table_setting.js"></script>
<script src="createOccurrenceTable.js"></script>
<script src="ranksort.js"></script>
<link rel="stylesheet" href="table.css">
</head>

<body>
<!--  タブ切り替え https://allabout.co.jp/gm/gc/23969/  -->

<p>
  <table id="table_setting"></table>
  <script>
  createSettingTable('table_setting')
  </script>
</p>

<hr>

<p>
  <table id='occurrence'>
  </table>

<input type="button" value="create occurrence table"  onclick="createOccurrenceTable(occ_tbl)" />
<input type="button" value="add row"  onclick="cloneRows(occ_tbl)" />
<input id="clone_n_row" type="number" value="5" step="1", min="1" max="20">
<input type="button" value="sort"  onclick="sortTable(occ_tbl)" />

</p>

<script>
let occ_tbl = 'occurrence';

// https://blog.ver001.com/javascript-table-sort/
var column_no = 0;       // now clicked
var column_no_prev = 0;  // previous clicked
var dir = "asc";
function setSortFunction(){
    document.querySelectorAll('#occurrence th').forEach(elm => {
        elm.onclick = function (){
            // settings
            var id_table = 'occurrence';
            var table = document.getElementById(id_table);
            column_no = this.cellIndex; // now clicked
            // sort direction: clicked: sort reverse
            if(column_no_prev !== column_no) {
              dir = "asc"; 
            } else if(column_no_prev === column_no && dir === "desc") {
              dir = "asc"; 
            } else if(column_no_prev === column_no && dir === "asc"){
              dir = "desc"; 
            } 
            column_no_prev = column_no;
            // rank_index: sorting order
            var col_name = getColNames(table)[column_no];
            var cl = "occ_" + col_name;
            const n_row = table.rows.length;
            switch(col_name){
                case "date":  // do nothing
                case "delButton":
                    // dammy rank_index(do not sort): [0, 1, 2, ..., i]
                    // avoid error in "rank_index.unshift(0)"
                    var rank_index = [];
                    for(let i=0; i<table.rows.length - 1; i++){ rank_index[i] = i; }
                    break;
                case "no":
                    var rank_index = rank(getInnerHTML(document.getElementsByClassName(cl)), dir);
                    break;
                default:
                    // fixed // for debug: var cl = "occ_"+getColNames(table)[2]
                    var val_0 = document.getElementsByClassName(cl)[0].firstChild.value;
                    if(val_0    === void 0){ // void 0 means undifined -> fixed text
                        // for debug:    var cl = "occ_"+getColNames(table)[5]
                        var rank_index = rank(getInnerHTML(document.getElementsByClassName(cl)), dir);
                        break;
                    } else {
                        switch(document.getElementsByClassName(cl)[0].firstChild.getAttribute("type")){
                            case "checkbox":
                                var rank_index = rank(getChecked(getFirstChild(document.getElementsByClassName(cl))), dir);
                                break;
                            case "text": 
                            case "number":
                                var rank_index = rank(getValues(getFirstChild(document.getElementsByClassName(cl))), dir);
                                break;
                            case null: // select from list
                                // for debug: var cl = "occ_"+getColNames(table)[6]
                                var rank_index = rank(getSelectedIndex(getFirstChild(document.getElementsByClassName(cl))), dir);
                                break;
                        }
                    }
                    break;
            }
            // sort table
            var trs = table.rows;
            for(let i=0; i<rank_index.length; i++){ rank_index[i]++; }
            rank_index.unshift(0);
console.log(column_no);
console.log(rank_index);
            var new_trs = sortByOrder(trs, rank_index);
            for(let i=0; i<new_trs.length; i++){
                table.appendChild(new_trs[i]);
            }
        }
    })
}



function sortTable(id_table){
// var id_table = "occurrence";
  var table = document.getElementById(id_table);
  var trs = table.rows;
  var key = "occ_" + "no";
  var key_cols = getInnerHTML(document.getElementsByClassName(key));
  var new_order = rank(key_cols, dir="desc");
  // th=0, add 1 to others
  for(let i=0; i<new_order.length; i++){ new_order[i]++; }
  new_order.unshift(0);
  var new_trs = sortByOrder(trs, new_order);
  for(let i=0; i<new_trs.length; i++){
    table.appendChild(new_trs[i]);
  }
}


// // // // // // // // // // // // // // // // // // // 
// 
//                 download用の値の取り出し
// 
// // // // // // // // // // // // // // // // // // // 
// 
//    if(row.children[i].firstChild.value === void 0){  // void 0 means undifined
//      row.children[i].innerHTML
//    } else {
//      row.children[i].firstChild.value
//    }
</script>



</body>
</html>
